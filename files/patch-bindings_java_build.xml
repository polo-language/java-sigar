--- bindings/java/build.xml.orig	2020-04-15 12:23:56 UTC
+++ bindings/java/build.xml
@@ -35,6 +35,7 @@
 
   <property name="jni.libversion" value="${file.version}"/>
   <property name="sigar.jar" value="sigar${file.version}.jar"/>
+  <property name="sigar.test.jar" value="sigar-test${file.version}.jar"/>
 
   &jni-build;
 
@@ -51,12 +52,13 @@
 
   <path id="libjars">
      <fileset dir="lib" includes="*.jar"/>
+     <pathelement location="${ant.library.dir}/ant-junit.jar"/>
+     <pathelement path="${junitjar}"/>
   </path>
 
   <path id="alljars">
      <path refid="libjars"/>
      <fileset dir="${sigar-bin}/lib" includes="${sigar.jar}"/>
-     <fileset dir="${ant.library.dir}" includes="junit*.jar"/>
   </path>
 
   <target name="javadoc_check">
@@ -92,9 +94,6 @@
 
   <target name="compile">
     <mkdir dir="${build}/classes"/>
-    <available classname="junit.framework.TestCase" property="junit.present">
-      <classpath refid="alljars"/>
-    </available>
     <javac destdir="${build}/classes"
            source="1.6" target="1.6"
            sourcepath=""
@@ -104,7 +103,6 @@
       <src path="${build}/src"/>
       <src path="${jni.src.java}"/>
       <include name="**/*.java"/>
-      <exclude name="**/test/*.java" unless="junit.present"/>
     </javac>
   </target>
 
@@ -257,13 +255,19 @@
 
   <target name="pack">
     <jar jarfile="${sigar-bin}/lib/${sigar.jar}"
-         basedir="${build}/classes">
+         basedir="${build}/classes"
+         excludes="**/test/**">
 
       <manifest>
         <attribute name="Main-Class"
                    value="org.hyperic.sigar.cmd.Runner"/>
       </manifest>
     </jar>
+
+    <jar jarfile="${sigar-bin}/lib/${sigar.test.jar}"
+         basedir="${build}/classes"
+         includes="**/test/**">
+    </jar>
   </target>
 
   <target name="build" depends="build-jni,compile,pack"/>
@@ -298,7 +302,6 @@
          jvm="${java.home}/bin/java"
          jar="${sigar-bin}/lib/${sigar.jar}">
      <arg value="version"/>
-     <arg value="${junit.args}"/>
    </java>
 
    <property name="junit.mx" value="-Dcom.sun.management.jmxremote"/>
@@ -308,6 +311,9 @@
      <jvmarg line="${junit.args} ${junit.mx}"/>
 
      <classpath refid="alljars"/>
+     <classpath>
+       <pathelement path="${sigar-bin}/lib/${sigar.test.jar}"/>
+     </classpath>
      <formatter type="xml"/>
 
      <batchtest fork="yes" todir="${testresults}">
